{% extends "base.html" %}

{% block title %}{{ tv.name }} ‚Äî XK Media{% endblock %}

{% block logo %}
<a href="/venue" class="logo">
    <span class="logo-icon">üì∫</span>
    XK Media
</a>
{% endblock %}

{% block nav %}
<a href="/venue">–û–±–∑–æ—Ä</a>
<a href="/venue/tvs">–ú–æ–∏ –¢–í</a>
<a href="/venue/earnings">–î–æ—Ö–æ–¥—ã</a>
<a href="/venue/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
<a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div>
        <a href="/venue/tvs" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        <h1>üì∫ {{ tv.name }}</h1>
        <p class="subtitle">{{ tv.venue_name or tv.address or "‚Äî" }}</p>
    </div>
    <div class="header-actions">
        <a href="/tv/{{ tv.code }}" class="btn btn-outline" target="_blank">QR-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üó</a>
        {% if tv.is_approved %}
        <span class="badge badge-success badge-lg">–ê–∫—Ç–∏–≤–µ–Ω</span>
        {% else %}
        <span class="badge badge-warning badge-lg">–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</span>
        {% endif %}
    </div>
</div>

<!-- Stats -->
<div class="grid grid-4">
    <div class="card stat-card">
        <div class="stat-icon">üëÅÔ∏è</div>
        <div class="stat-value">{{ "{:,}".format(total_impressions).replace(",", " ") }}</div>
        <div class="stat-label">–ü–æ–∫–∞–∑–æ–≤</div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon">üëÜ</div>
        <div class="stat-value">{{ total_clicks }}</div>
        <div class="stat-label">–ü–µ—Ä–µ—Ö–æ–¥–æ–≤</div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon">üì¢</div>
        <div class="stat-value">{{ active_subs_count }}</div>
        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</div>
    </div>
    <div class="card stat-card highlight">
        <div class="stat-icon">üí∞</div>
        <div class="stat-value">{{ total_earned }} ‚ÇΩ</div>
        <div class="stat-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
    </div>
</div>

<div class="grid grid-2">
    <!-- TV Info Form -->
    <div class="card">
        <div class="card-header">
            <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¢–í</h3>
        </div>
        <div class="card-content">
            <form method="POST" action="/venue/tv/{{ tv.id }}">
                <div class="form-group">
                    <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ –¢–í</label>
                    <input type="text" id="name" name="name" value="{{ tv.name }}" required>
                </div>
                
                <div class="form-group">
                    <label for="venue_name">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</label>
                    <input type="text" id="venue_name" name="venue_name" value="{{ tv.venue_name or '' }}">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select id="category" name="category">
                            {% for key, value in categories.items() %}
                            <option value="{{ key }}" {{ 'selected' if tv.category == key else '' }}>{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="target_audience">–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</label>
                        <select id="target_audience" name="target_audience">
                            {% for key, value in audiences.items() %}
                            <option value="{{ key }}" {{ 'selected' if tv.target_audience == key else '' }}>{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="city">–ì–æ—Ä–æ–¥</label>
                        <input type="text" id="city" name="city" value="{{ tv.city or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="address">–ê–¥—Ä–µ—Å</label>
                        <input type="text" id="address" name="address" value="{{ tv.address or '' }}">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="clients_per_day">–ö–ª–∏–µ–Ω—Ç–æ–≤ –≤ –¥–µ–Ω—å</label>
                        <input type="number" id="clients_per_day" name="clients_per_day" value="{{ tv.clients_per_day or 0 }}">
                    </div>
                    <div class="form-group">
                        <label for="avg_check">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫, ‚ÇΩ</label>
                        <input type="number" id="avg_check" name="avg_check" step="0.01" value="{{ tv.avg_check or 0 }}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="working_hours">–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã</label>
                    <input type="text" id="working_hours" name="working_hours" value="{{ tv.working_hours or '' }}">
                </div>
                
                <div class="form-group">
                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="description" name="description" rows="3">{{ tv.description or '' }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="photo_url">–§–æ—Ç–æ (URL)</label>
                    <input type="url" id="photo_url" name="photo_url" value="{{ tv.photo_url or '' }}">
                </div>
                
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- Legal Info Form -->
    <div class="card">
        <div class="card-header">
            <h3>üìÑ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</h3>
            <span class="badge badge-info">–î–ª—è –≤—ã–ø–ª–∞—Ç</span>
        </div>
        <div class="card-content">
            <form method="POST" action="/venue/tv/{{ tv.id }}/legal">
                <div class="form-group">
                    <label for="legal_name">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="legal_name" name="legal_name" value="{{ tv.legal_name or '' }}">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="inn">–ò–ù–ù</label>
                        <input type="text" id="inn" name="inn" value="{{ tv.inn or '' }}" maxlength="12">
                    </div>
                    <div class="form-group">
                        <label for="kpp">–ö–ü–ü</label>
                        <input type="text" id="kpp" name="kpp" value="{{ tv.kpp or '' }}" maxlength="9">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="bank_name">–ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞</label>
                    <input type="text" id="bank_name" name="bank_name" value="{{ tv.bank_name or '' }}">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="bank_bik">–ë–ò–ö</label>
                        <input type="text" id="bank_bik" name="bank_bik" value="{{ tv.bank_bik or '' }}" maxlength="9">
                    </div>
                    <div class="form-group">
                        <label for="bank_account">–†–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç</label>
                        <input type="text" id="bank_account" name="bank_account" value="{{ tv.bank_account or '' }}" maxlength="20">
                    </div>
                </div>
                
                <hr class="divider">
                
                <div class="form-group">
                    <label for="contact_person">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
                    <input type="text" id="contact_person" name="contact_person" value="{{ tv.contact_person or '' }}">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="contact_phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="tel" id="contact_phone" name="contact_phone" value="{{ tv.contact_phone or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="contact_email">Email</label>
                        <input type="email" id="contact_email" name="contact_email" value="{{ tv.contact_email or '' }}">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>
</div>

<!-- Tariff Info -->
<div class="card">
    <div class="card-header">
        <h3>üíé –¢–∞—Ä–∏—Ñ</h3>
    </div>
    <div class="card-content">
        <div class="tariff-info">
            <div class="tariff-current">
                <div class="tariff-type">
                    {% if tv.equipment_type == 'venue' %}
                    üì∫ –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
                    {% else %}
                    üñ•Ô∏è –¢–í –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞ XK Media
                    {% endif %}
                </div>
                <div class="tariff-share">
                    –í–∞—à–∞ –¥–æ–ª—è: <span class="accent">{{ tv.revenue_share | int }}%</span>
                </div>
            </div>
            <p class="tariff-note">
                –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: <a href="mailto:support@xk-media.ru">support@xk-media.ru</a>
            </p>
        </div>
    </div>
</div>

<!-- Advertisers on this TV -->
<div class="card">
    <div class="card-header">
        <h3>üì¢ –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–∏ –Ω–∞ —ç—Ç–æ–º –¢–í</h3>
    </div>
    <div class="card-content">
        {% if links %}
        <table class="table">
            <thead>
                <tr>
                    <th>–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</th>
                    <th>–†–µ–∫–ª–∞–º–∞</th>
                    <th>–ü–æ–∫–∞–∑—ã</th>
                    <th>–ü–µ—Ä–µ—Ö–æ–¥—ã</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for link in links %}
                <tr>
                    <td>
                        <strong>{{ link.advertiser_name or "‚Äî" }}</strong>
                        {% if link.advertiser and link.advertiser.website %}
                        <br><a href="{{ link.advertiser.website }}" target="_blank" class="link-small">{{ link.advertiser.website }}</a>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ link.title }}</strong>
                        <br><span class="text-secondary">{{ link.description or "‚Äî" }}</span>
                    </td>
                    <td>{{ "{:,}".format(link.impressions or 0).replace(",", " ") }}</td>
                    <td>{{ link.clicks or 0 }}</td>
                    <td>
                        <span class="badge {{ 'badge-success' if link.is_active else 'badge-secondary' }}">
                            {{ "–ê–∫—Ç–∏–≤–Ω–∞" if link.is_active else "–ù–µ–∞–∫—Ç–∏–≤–Ω–∞" }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state-small">
            <p>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π –Ω–∞ —ç—Ç–æ–º –¢–í</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Subscriptions -->
<div class="card">
    <div class="card-header">
        <h3>üìÖ –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–ø–∏—Å–æ–∫</h3>
    </div>
    <div class="card-content">
        {% if subscriptions %}
        <table class="table">
            <thead>
                <tr>
                    <th>–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</th>
                    <th>–ü–µ—Ä–∏–æ–¥</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                    <th>–í–∞—à–∞ –¥–æ–ª—è</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for sub in subscriptions %}
                <tr>
                    <td>{{ sub.advertiser.company_name or sub.advertiser.email if sub.advertiser else "‚Äî" }}</td>
                    <td>{{ sub.start_date.strftime("%d.%m") }} ‚Äî {{ sub.end_date.strftime("%d.%m.%Y") }}</td>
                    <td>{{ "{:,.0f}".format(sub.price).replace(",", " ") }} ‚ÇΩ</td>
                    <td class="amount">{{ "{:,.0f}".format(sub.venue_payout or 0).replace(",", " ") }} ‚ÇΩ</td>
                    <td>
                        {% set today = sub.start_date.__class__.today() %}
                        {% if sub.start_date <= today <= sub.end_date %}
                        <span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% elif today < sub.start_date %}
                        <span class="badge badge-info">–û–∂–∏–¥–∞–µ—Ç</span>
                        {% else %}
                        <span class="badge badge-secondary">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state-small">
            <p>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –ø—É—Å—Ç–∞</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
.form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

.tariff-info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.tariff-current {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.tariff-type {
    font-size: 1.1rem;
    font-weight: 600;
}

.tariff-share {
    font-size: 1.1rem;
}

.tariff-share .accent {
    font-weight: 700;
    font-size: 1.5rem;
    color: var(--accent);
}

.tariff-note {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.badge-lg {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.back-link {
    display: inline-block;
    color: var(--text-secondary);
    text-decoration: none;
    margin-bottom: 0.5rem;
}

.back-link:hover {
    color: var(--accent);
}

.divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 1.5rem 0;
}

.link-small {
    font-size: 0.85rem;
    color: var(--accent);
}
</style>
{% endblock %}
