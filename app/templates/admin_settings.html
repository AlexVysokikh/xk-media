{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞ ‚Äî XK Media{% endblock %}

{% block logo %}
<a href="/admin" class="logo">
    <span class="logo-icon">üì∫</span>
    XK Media
</a>
{% endblock %}

{% block nav %}
<a href="/admin">–î–∞—à–±–æ—Ä–¥</a>
<a href="/admin/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
<a href="/admin/tvs">–≠–∫—Ä–∞–Ω—ã</a>
<a href="/admin/payments">–ü–ª–∞—Ç–µ–∂–∏</a>
<a href="/admin/payouts">–í—ã–ø–ª–∞—Ç—ã</a>
<a href="/admin/settings" class="active">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
<a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞</h1>
    <p class="page-subtitle">–û—Ñ–µ—Ä—Ç–∞ –∏ –¥—Ä—É–≥–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</p>
</div>

{% if success %}
<div class="alert alert-success">{{ success }}</div>
{% endif %}

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

<div class="grid grid-2">
    <!-- Offer Settings -->
    <div class="card">
        <div class="card-header">
            <h3>üìú –û—Ñ–µ—Ä—Ç–∞</h3>
            <a href="/offer" class="btn btn-sm" target="_blank">–ü—Ä–æ—Å–º–æ—Ç—Ä ‚Üó</a>
        </div>
        <div class="card-content">
            <form method="POST" action="/admin/settings/offer">
                <div class="form-group">
                    <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="title" name="title" value="{{ offer.title if offer else '–û—Ñ–µ—Ä—Ç–∞' }}" placeholder="–û—Ñ–µ—Ä—Ç–∞">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="version">–í–µ—Ä—Å–∏—è</label>
                        <input type="text" id="version" name="version" value="{{ offer.version if offer else '1.0' }}" placeholder="1.0">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="is_active" {{ 'checked' if offer and offer.is_active else 'checked' }}>
                            –ê–∫—Ç–∏–≤–Ω–∞
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="content">–¢–µ–∫—Å—Ç –æ—Ñ–µ—Ä—Ç—ã (HTML)</label>
                    <textarea id="content" name="content" rows="20" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ñ–µ—Ä—Ç—ã...">{{ offer.content if offer else '' }}</textarea>
                    <span class="form-hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML-—Ä–∞–∑–º–µ—Ç–∫–∞: &lt;h2&gt;, &lt;h3&gt;, &lt;p&gt;, &lt;ul&gt;, &lt;ol&gt;, &lt;li&gt;, &lt;strong&gt;, &lt;em&gt;</span>
                </div>
                
                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ñ–µ—Ä—Ç—É</button>
            </form>
        </div>
    </div>

    <!-- Stats & Quick Links -->
    <div>
        <div class="card">
            <div class="card-header">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–≥–ª–∞—Å–∏–π</h3>
            </div>
            <div class="card-content">
                <a href="/admin/users/offers" class="stats-link">
                    <span>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–∏–Ω—è–≤—à–∏—Ö –æ—Ñ–µ—Ä—Ç—É ‚Üí</span>
                </a>
            </div>
        </div>
        
        <div class="card" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h3>üîê OAuth –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            </div>
            <div class="card-content">
                <form method="POST" action="/admin/settings/oauth" id="oauth-form">
                    <div class="form-group">
                        <label for="base_url">Base URL (–¥–ª—è redirect URI)</label>
                        <input type="text" id="base_url" name="base_url" value="{{ settings.BASE_URL }}" placeholder="https://yourdomain.com" required>
                        <span class="form-hint">–ë–∞–∑–æ–≤—ã–π URL –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ (–±–µ–∑ —Å–ª–µ—à–∞ –≤ –∫–æ–Ω—Ü–µ)</span>
                    </div>
                    
                    <div style="margin: 2rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <h4 style="margin-top: 0;">üîµ Google OAuth</h4>
                        <div class="form-group">
                            <label for="google_client_id">Google Client ID</label>
                            <input type="text" id="google_client_id" name="google_client_id" value="{{ settings.GOOGLE_CLIENT_ID or '' }}" placeholder="xxxxx.apps.googleusercontent.com">
                        </div>
                        <div class="form-group">
                            <label for="google_client_secret">Google Client Secret</label>
                            <input type="password" id="google_client_secret" name="google_client_secret" value="{{ settings.GOOGLE_CLIENT_SECRET or '' }}" placeholder="GOCSPX-xxxxx">
                        </div>
                        <div class="form-hint">
                            <strong>Redirect URI:</strong> <code id="google-redirect">{{ settings.BASE_URL.rstrip('/') }}/oauth/google/callback</code><br>
                            <a href="https://console.cloud.google.com/apis/credentials" target="_blank">–°–æ–∑–¥–∞—Ç—å OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí</a>
                        </div>
                    </div>
                    
                    <div style="margin: 2rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <h4 style="margin-top: 0;">üü° Yandex OAuth</h4>
                        <div class="form-group">
                            <label for="yandex_client_id">Yandex Client ID</label>
                            <input type="text" id="yandex_client_id" name="yandex_client_id" value="{{ settings.YANDEX_CLIENT_ID or '' }}" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx">
                        </div>
                        <div class="form-group">
                            <label for="yandex_client_secret">Yandex Client Secret</label>
                            <input type="password" id="yandex_client_secret" name="yandex_client_secret" value="{{ settings.YANDEX_CLIENT_SECRET or '' }}" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx">
                        </div>
                        <div class="form-hint">
                            <strong>Redirect URI:</strong> <code id="yandex-redirect">{{ settings.BASE_URL.rstrip('/') }}/oauth/yandex/callback</code><br>
                            <a href="https://oauth.yandex.ru/" target="_blank">–°–æ–∑–¥–∞—Ç—å OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí</a>
                        </div>
                    </div>
                    
                    <div style="margin: 2rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <h4 style="margin-top: 0;">üî¥ VK OAuth</h4>
                        <div class="form-group">
                            <label for="vk_client_id">VK Client ID (Application ID)</label>
                            <input type="text" id="vk_client_id" name="vk_client_id" value="{{ settings.VK_CLIENT_ID or '' }}" placeholder="12345678">
                        </div>
                        <div class="form-group">
                            <label for="vk_client_secret">VK Client Secret (Secure Key)</label>
                            <input type="password" id="vk_client_secret" name="vk_client_secret" value="{{ settings.VK_CLIENT_SECRET or '' }}" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx">
                        </div>
                        <div class="form-hint">
                            <strong>Redirect URI:</strong> <code id="vk-redirect">{{ settings.BASE_URL.rstrip('/') }}/oauth/vk/callback</code><br>
                            <a href="https://dev.vk.com/apps?act=manage" target="_blank">–°–æ–∑–¥–∞—Ç—å OAuth –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí</a>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å OAuth –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    <button type="button" onclick="checkOAuth()" class="btn btn-outline" style="margin-left: 0.5rem;">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</button>
                </form>
                
                <div id="oauth-status" style="margin-top: 1.5rem;"></div>
            </div>
        </div>
        
        <div class="card" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h3>üìù –ü—Ä–∏–º–µ—Ä –æ—Ñ–µ—Ä—Ç—ã</h3>
            </div>
            <div class="card-content">
                <div class="example-offer">
<pre>&lt;h2&gt;1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è&lt;/h2&gt;
&lt;p&gt;–ù–∞—Å—Ç–æ—è—â–∞—è –û—Ñ–µ—Ä—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –û–û–û "XK Media" (–¥–∞–ª–µ–µ ‚Äî –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å) –∑–∞–∫–ª—é—á–∏—Ç—å –î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ–∫–∞–∑–∞–Ω–∏–µ —É—Å–ª—É–≥ –ø–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é —Ä–µ–∫–ª–∞–º—ã.&lt;/p&gt;

&lt;h2&gt;2. –ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞&lt;/h2&gt;
&lt;p&gt;–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –æ–∫–∞–∑–∞—Ç—å –ó–∞–∫–∞–∑—á–∏–∫—É —É—Å–ª—É–≥–∏ –ø–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –Ω–∞ –¢–í-—ç–∫—Ä–∞–Ω–∞—Ö —Å–µ—Ç–∏ XK Media.&lt;/p&gt;

&lt;h2&gt;3. –°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥&lt;/h2&gt;
&lt;ul&gt;
    &lt;li&gt;–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤—É—é—â–∏–º –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–º&lt;/li&gt;
    &lt;li&gt;–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –Ω–∞ —É—Å–ª–æ–≤–∏—è—Ö 100% –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã&lt;/li&gt;
&lt;/ul&gt;

&lt;h2&gt;4. –ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å—Ç–æ—Ä–æ–Ω&lt;/h2&gt;
&lt;p&gt;...&lt;/p&gt;</pre>
                </div>
                <button onclick="document.getElementById('content').value = this.previousElementSibling.querySelector('pre').textContent; return false;" class="btn btn-sm btn-outline" style="margin-top: 1rem;">–í—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
            </div>
        </div>
    </div>
</div>

<script>
// Update redirect URIs when base_url changes
document.getElementById('base_url')?.addEventListener('input', function() {
    const baseUrl = this.value.trim().replace(/\/$/, '');
    if (baseUrl) {
        document.getElementById('google-redirect').textContent = baseUrl + '/oauth/google/callback';
        document.getElementById('yandex-redirect').textContent = baseUrl + '/oauth/yandex/callback';
        document.getElementById('vk-redirect').textContent = baseUrl + '/oauth/vk/callback';
    }
});

async function checkOAuth() {
    const statusDiv = document.getElementById('oauth-status');
    statusDiv.innerHTML = '<div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>';
    
    try {
        const response = await fetch('/api/admin/oauth/check');
        const data = await response.json();
        
        let html = `<div style="font-size: 0.9rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">`;
        html += `<p><strong>Base URL:</strong> ${data.base_url}</p>`;
        
        let allConfigured = true;
        for (const [provider, config] of Object.entries(data.providers)) {
            const providerName = provider.charAt(0).toUpperCase() + provider.slice(1);
            const status = config.configured ? '‚úÖ' : '‚ùå';
            if (!config.configured) allConfigured = false;
            
            html += `<div style="margin: 1rem 0; padding: 1rem; background: rgba(0,0,0,0.1); border-radius: 8px;">`;
            html += `<strong>${status} ${providerName}</strong><br>`;
            if (config.configured) {
                html += `<span style="color: var(--success);">–ù–∞—Å—Ç—Ä–æ–µ–Ω</span><br>`;
            } else {
                html += `<span style="color: var(--error);">–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span><br>`;
            }
            html += `Redirect URI: <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; font-size: 0.85rem;">${config.redirect_uri}</code><br>`;
            html += `<a href="${config.setup_url}" target="_blank" style="color: var(--accent); font-size: 0.85rem; margin-top: 0.5rem; display: inline-block;">${config.instructions} ‚Üí</a>`;
            html += `</div>`;
        }
        
        if (allConfigured) {
            html += `<div style="margin-top: 1rem; padding: 1rem; background: rgba(0,255,0,0.1); border-radius: 8px; color: var(--success);">‚úÖ –í—Å–µ OAuth –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!</div>`;
        }
        
        html += `</div>`;
        statusDiv.innerHTML = html;
    } catch (error) {
        statusDiv.innerHTML = `<div style="color: var(--error); padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">–û—à–∏–±–∫–∞: ${error.message}</div>`;
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', function() {
    setTimeout(checkOAuth, 500);
});
</script>

<style>
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    align-items: end;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.5rem 0;
}

.checkbox-label input {
    width: 18px;
    height: 18px;
}

textarea {
    font-family: monospace;
    font-size: 0.9rem;
    line-height: 1.5;
}

.stats-link {
    display: block;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
    color: var(--accent);
    text-decoration: none;
    transition: all 0.2s;
}

.stats-link:hover {
    background: rgba(233, 69, 96, 0.1);
}

.example-offer {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 1rem;
    overflow-x: auto;
}

.example-offer pre {
    margin: 0;
    font-size: 0.8rem;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
}
</style>
{% endblock %}
