{% extends "base.html" %}

{% block title %}–í—ã–ø–ª–∞—Ç—ã ‚Äî –ê–¥–º–∏–Ω{% endblock %}

{% block logo %}
<a href="/admin" class="logo">
    <span class="logo-icon">üì∫</span>
    XK Media
</a>
{% endblock %}

{% block nav %}
<a href="/admin">–î–∞—à–±–æ—Ä–¥</a>
<a href="/admin/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
<a href="/admin/tvs">–≠–∫—Ä–∞–Ω—ã</a>
<a href="/admin/payments">–ü–ª–∞—Ç–µ–∂–∏</a>
<a href="/admin/payouts" class="active">–í—ã–ø–ª–∞—Ç—ã</a>
<a href="/admin/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
<a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üí∏ –í—ã–ø–ª–∞—Ç—ã –ø–ª–æ—â–∞–¥–∫–∞–º</h1>
    <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–ø–ª–∞—Ç–∞–º–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞–º –¢–í-—ç–∫—Ä–∞–Ω–æ–≤</p>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="grid grid-3" style="margin-bottom: 1.5rem;">
    <div class="card stat-card">
        <div class="stat-value">{{ stats.total_payouts }} ‚ÇΩ</div>
        <div class="stat-label">–í—Å–µ–≥–æ –≤—ã–ø–ª–∞—á–µ–Ω–æ</div>
    </div>
    <div class="card stat-card">
        <div class="stat-value" style="color: var(--warning);">{{ stats.pending_payouts }} ‚ÇΩ</div>
        <div class="stat-label">–û–∂–∏–¥–∞—é—Ç –≤—ã–ø–ª–∞—Ç—ã</div>
    </div>
    <div class="card stat-card">
        <div class="stat-value">{{ stats.venues_count }}</div>
        <div class="stat-label">–ü–ª–æ—â–∞–¥–æ–∫</div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üìä –ù–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º</h3>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>–ü–ª–æ—â–∞–¥–∫–∞</th>
                <th>–¢–í</th>
                <th>–ù–∞—á–∏—Å–ª–µ–Ω–æ</th>
                <th>–í—ã–ø–ª–∞—á–µ–Ω–æ</th>
                <th>–ö –≤—ã–ø–ª–∞—Ç–µ</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for item in venue_stats %}
            <tr>
                <td>
                    <div style="font-weight: 600;">{{ item.venue.company_name or item.venue.email }}</div>
                    {% if item.venue.inn %}
                    <div style="font-size: 0.75rem; color: var(--text-muted);">–ò–ù–ù: {{ item.venue.inn }}</div>
                    {% endif %}
                </td>
                <td>{{ item.tv_count }}</td>
                <td>{{ "%.0f"|format(item.total_earned) }} ‚ÇΩ</td>
                <td style="color: var(--success);">{{ "%.0f"|format(item.total_paid) }} ‚ÇΩ</td>
                <td style="font-weight: 700; color: var(--warning);">{{ "%.0f"|format(item.pending) }} ‚ÇΩ</td>
                <td>
                    {% if item.pending > 0 %}
                    <a href="/admin/payout/create?venue_id={{ item.venue.id }}&amount={{ item.pending }}" 
                       class="btn btn-primary btn-sm">–í—ã–ø–ª–∞—Ç–∏—Ç—å</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% if not venue_stats %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è—Ö
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title">üìú –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç</h3>
        <button onclick="document.getElementById('payoutModal').style.display='flex'" class="btn btn-primary btn-sm">
            + –°–æ–∑–¥–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É
        </button>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–î–∞—Ç–∞</th>
                <th>–ü–ª–æ—â–∞–¥–∫–∞</th>
                <th>–ü–µ—Ä–∏–æ–¥</th>
                <th>–°—É–º–º–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for p in payouts %}
            <tr>
                <td>#{{ p.id }}</td>
                <td>{{ p.created_at.strftime('%d.%m.%Y') }}</td>
                <td>
                    {% if p.venue %}
                    {{ p.venue.company_name or p.venue.email }}
                    {% else %}
                    ID: {{ p.venue_id }}
                    {% endif %}
                </td>
                <td>{{ p.period_start.strftime('%d.%m') }} ‚Äî {{ p.period_end.strftime('%d.%m.%Y') }}</td>
                <td style="font-weight: 700;">{{ "%.0f"|format(p.amount) }} ‚ÇΩ</td>
                <td>
                    {% if p.status == 'paid' %}
                    <span class="badge badge-success">–í—ã–ø–ª–∞—á–µ–Ω–æ</span>
                    {% elif p.status == 'processing' %}
                    <span class="badge badge-warning">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span>
                    {% else %}
                    <span class="badge badge-info">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                    {% endif %}
                </td>
                <td>
                    {% if p.status == 'pending' %}
                    <a href="/admin/payout/{{ p.id }}/process" class="btn btn-secondary btn-sm">–í –æ–±—Ä–∞–±–æ—Ç–∫—É</a>
                    {% elif p.status == 'processing' %}
                    <a href="/admin/payout/{{ p.id }}/complete" class="btn btn-primary btn-sm">–ó–∞–≤–µ—Ä—à–∏—Ç—å</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% if not payouts %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    –í—ã–ø–ª–∞—Ç –ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã–ø–ª–∞—Ç—ã -->
<div id="payoutModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 2rem;">
    <div class="card" style="max-width: 500px; width: 100%;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">üí∏ –°–æ–∑–¥–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É</h3>
            <button onclick="document.getElementById('payoutModal').style.display='none'" 
                    style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">√ó</button>
        </div>
        <form method="POST" action="/admin/payout/create">
            <div class="form-group">
                <label class="form-label">–ü–ª–æ—â–∞–¥–∫–∞</label>
                <select name="venue_id" class="form-input" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–æ—â–∞–¥–∫—É...</option>
                    {% for v in venues %}
                    <option value="{{ v.id }}">{{ v.company_name or v.email }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">–ü–µ—Ä–∏–æ–¥ —Å</label>
                    <input type="date" name="period_start" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–µ—Ä–∏–æ–¥ –ø–æ</label>
                    <input type="date" name="period_end" class="form-input" required>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">–°—É–º–º–∞ (‚ÇΩ)</label>
                <input type="number" name="amount" class="form-input" min="1" step="1" required>
            </div>
            <div class="form-group">
                <label class="form-label">–†–µ–∫–≤–∏–∑–∏—Ç—ã / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea name="payment_details" class="form-input" rows="2"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                <button type="button" onclick="document.getElementById('payoutModal').style.display='none'" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
