{% extends "base.html" %}

{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî XK Media{% endblock %}

{% block head %}
<style>
    .metric-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .metric-card.highlight {
        background: linear-gradient(135deg, var(--accent), #ff6b6b);
        border: none;
    }
    .metric-card.highlight .metric-value,
    .metric-card.highlight .metric-label,
    .metric-card.highlight .metric-icon {
        color: white;
    }
    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: var(--secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    .metric-card.highlight .metric-icon {
        background: rgba(255,255,255,0.2);
    }
    .metric-content {
        flex: 1;
        min-width: 0;
    }
    .metric-value {
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
        color: var(--text);
    }
    .metric-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        white-space: nowrap;
    }
    .metric-action {
        margin-top: 0.5rem;
    }
    .quick-stats {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.25rem;
    }
    .quick-stat {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        background: var(--secondary);
        border-radius: 4px;
        color: var(--text-muted);
    }
    .metric-card.highlight .quick-stat {
        background: rgba(255,255,255,0.15);
        color: rgba(255,255,255,0.9);
    }
</style>
{% endblock %}

{% block logo %}
<a href="/advertiser" class="logo">
    <span class="logo-icon">üì∫</span>
    XK Media
</a>
{% endblock %}

{% block nav %}
<a href="/advertiser" class="active">–î–∞—à–±–æ—Ä–¥</a>
<a href="/advertiser/stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
<a href="/advertiser/subscriptions">–ü–æ–¥–ø–∏—Å–∫–∏</a>
<a href="/advertiser/payments">–ü–ª–∞—Ç–µ–∂–∏</a>
<a href="/advertiser/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
<form method="POST" action="/switch-role" style="display: inline-block; margin: 0;">
    <input type="hidden" name="role" value="venue">
    <button type="submit" class="btn btn-secondary btn-sm" style="background: rgba(131, 56, 236, 0.2); border-color: var(--accent-tertiary); color: var(--accent-tertiary);" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ –∫–∞–±–∏–Ω–µ—Ç –ø–ª–æ—â–∞–¥–∫–∏">üì∫ –ü–ª–æ—â–∞–¥–∫–∞</button>
</form>
<a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
{% endblock %}

{% block content %}
<div class="page-header" style="margin-bottom: 1.5rem;">
    <h1 class="page-title">üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.first_name or user.company_name or user.email }}!</h1>
    <p class="page-subtitle">–û–±–∑–æ—Ä –≤–∞—à–∏—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π</p>
</div>

<!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É -->
<div class="grid grid-4" style="margin-bottom: 1.5rem;">
    <div class="metric-card highlight">
        <div class="metric-icon">üí∞</div>
        <div class="metric-content">
            <div class="metric-value">{{ stats.balance }} ‚ÇΩ</div>
            <div class="metric-label">–ë–∞–ª–∞–Ω—Å</div>
            <a href="/advertiser/payments" class="btn btn-sm" style="margin-top: 0.5rem; padding: 0.35rem 0.75rem; font-size: 0.75rem; background: rgba(255,255,255,0.2); border: none; color: white;">+ –ü–æ–ø–æ–ª–Ω–∏—Ç—å</a>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon" style="color: var(--accent);">üì∫</div>
        <div class="metric-content">
            <div class="metric-value" style="color: var(--accent);">{{ stats.total_impressions }}</div>
            <div class="metric-label">–ü–æ–∫–∞–∑–æ–≤</div>
            <div class="quick-stats">
                <span class="quick-stat">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</span>
            </div>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon" style="color: var(--success);">üñ±Ô∏è</div>
        <div class="metric-content">
            <div class="metric-value" style="color: var(--success);">{{ stats.total_clicks }}</div>
            <div class="metric-label">–ü–µ—Ä–µ—Ö–æ–¥–æ–≤ (CPC)</div>
            <div class="quick-stats">
                <span class="quick-stat">–ù–∞ –≤–∞—à–∏ —Å–∞–π—Ç—ã</span>
            </div>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon" style="color: #6495ed;">üìç</div>
        <div class="metric-content">
            <div class="metric-value" style="color: #6495ed;">{{ stats.active_tvs }}</div>
            <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –¢–í</div>
            <div class="quick-stats">
                <span class="quick-stat">–†–∞–∑–º–µ—â–µ–Ω–∏–π</span>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-2">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¢–í-—ç–∫—Ä–∞–Ω–∞–º -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">üì∫ –ü–æ–∫–∞–∑—ã –ø–æ –¢–í-—ç–∫—Ä–∞–Ω–∞–º</h3>
            <div style="display: flex; gap: 0.5rem;">
                <a href="/advertiser/stats" class="btn btn-secondary btn-sm">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                <a href="/advertiser/export/csv" class="btn btn-secondary btn-sm" title="–í—ã–≥—Ä—É–∑–∏—Ç—å CSV">üì•</a>
            </div>
        </div>
        
        {% if campaigns %}
        <table class="table" style="margin: -0.5rem -1.5rem -1.5rem; width: calc(100% + 3rem);">
            <thead>
                <tr>
                    <th>–¢–í-—ç–∫—Ä–∞–Ω</th>
                    <th style="text-align: right;">–ü–æ–∫–∞–∑—ã</th>
                    <th style="text-align: right;">CPC</th>
                    <th style="text-align: center;">–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for c in campaigns %}
                <tr>
                    <td>
                        <div style="font-weight: 600;">{{ c.tv.name }}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">{{ c.tv.venue_name or c.tv.address or '‚Äî' }}</div>
                    </td>
                    <td style="text-align: right;">
                        <span style="font-weight: 600; color: var(--accent);">{{ c.impressions or 0 }}</span>
                    </td>
                    <td style="text-align: right;">
                        <span style="font-weight: 600; color: var(--success);">{{ c.clicks or 0 }}</span>
                    </td>
                    <td style="text-align: center;">
                        {% if c.is_active %}
                        <span class="badge badge-success">‚óè</span>
                        {% else %}
                        <span class="badge badge-danger">‚óè</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot style="background: var(--secondary);">
                <tr>
                    <td style="font-weight: 600;">–ò—Ç–æ–≥–æ:</td>
                    <td style="text-align: right; font-weight: 700; color: var(--accent);">{{ stats.total_impressions }}</td>
                    <td style="text-align: right; font-weight: 700; color: var(--success);">{{ stats.total_clicks }}</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
            <p style="font-size: 1rem; margin-bottom: 0.5rem;">üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–∑–º–µ—â–µ–Ω–∏–π</p>
            <a href="/advertiser/subscriptions" class="btn btn-primary btn-sm" style="margin-top: 0.5rem;">–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</a>
        </div>
        {% endif %}
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ -->
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.75rem; margin-bottom: 0.75rem;">
                <h3 class="card-title" style="font-size: 1.1rem;">üìÖ –ü–æ–¥–ø–∏—Å–∫–∏</h3>
                <a href="/advertiser/subscriptions" class="btn btn-primary btn-sm" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;">+ –û—Ñ–æ—Ä–º–∏—Ç—å</a>
            </div>
            {% if subscriptions %}
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                {% for s in subscriptions[:3] %}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0.75rem; background: var(--secondary); border-radius: 6px; border-left: 3px solid {% if s.is_active %}var(--success){% else %}var(--text-muted){% endif %};">
                    <div style="min-width: 0;">
                        <div style="font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ s.tv.name }}</div>
                        <div style="font-size: 0.7rem; color: var(--text-muted);">{{ s.start_date.strftime('%d.%m') }} ‚Äî {{ s.end_date.strftime('%d.%m.%Y') }}</div>
                    </div>
                    <div style="text-align: right; flex-shrink: 0; margin-left: 0.5rem;">
                        <div style="font-weight: 600; font-size: 0.9rem;">{{ "%.0f"|format(s.price) }} ‚ÇΩ</div>
                        {% if s.is_active %}<span class="badge badge-success" style="font-size: 0.6rem; padding: 0.15rem 0.4rem;">‚óè</span>{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if subscriptions|length > 3 %}
            <div style="margin-top: 0.5rem; text-align: center;">
                <a href="/advertiser/subscriptions" style="font-size: 0.8rem;">–í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ ({{ subscriptions|length }}) ‚Üí</a>
            </div>
            {% endif %}
            {% else %}
            <div style="text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
            </div>
            {% endif %}
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏ -->
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.75rem; margin-bottom: 0.75rem;">
                <h3 class="card-title" style="font-size: 1.1rem;">üí≥ –ü–ª–∞—Ç–µ–∂–∏</h3>
                <a href="/advertiser/payments" style="font-size: 0.8rem;">–í—Å–µ ‚Üí</a>
            </div>
            {% if payments %}
            <div style="display: flex; flex-direction: column; gap: 0.4rem;">
                {% for p in payments[:4] %}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; border-bottom: 1px solid var(--border);">
                    <div>
                        <span style="font-weight: 500;">+{{ "%.0f"|format(p.amount) }} ‚ÇΩ</span>
                        <span style="font-size: 0.7rem; color: var(--text-muted); margin-left: 0.5rem;">{{ p.created_at.strftime('%d.%m.%y') }}</span>
                    </div>
                    {% if p.status == 'succeeded' %}
                    <span style="color: var(--success); font-size: 0.9rem;">‚úì</span>
                    {% elif p.status in ['pending', 'waiting'] %}
                    <span style="color: var(--warning); font-size: 0.9rem;">‚è≥</span>
                    {% else %}
                    <span style="color: var(--accent); font-size: 0.9rem;">‚úó</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; font-size: 0.85rem;">
                <span style="color: var(--text-muted);">–í—Å–µ–≥–æ:</span>
                <span style="font-weight: 600; color: var(--success);">{{ stats.total_paid }} ‚ÇΩ</span>
            </div>
            {% else %}
            <div style="text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                –ü–ª–∞—Ç–µ–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–∏–∫–∞ -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üé¨ –†–∞–∑–º–µ—Å—Ç–∏—Ç—å —Ä–æ–ª–∏–∫</h3>
    </div>
    <div class="card-content">
        {% if request.query_params.get('success') == 'video_sent' %}
        <div class="alert alert-success" style="margin-bottom: 1rem;">
            ‚úÖ –†–æ–ª–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ú—ã –ø–æ–ª—É—á–∏–ª–∏ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.
        </div>
        {% elif request.query_params.get('error') == 'video_upload_failed' %}
        <div class="alert alert-error" style="margin-bottom: 1rem;">
            ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–æ–ª–∏–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.
        </div>
        {% elif request.query_params.get('error') == 'video_too_large' %}
        <div class="alert alert-error" style="margin-bottom: 1rem;">
            ‚ùå –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 100 –ú–ë. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
        </div>
        {% elif request.query_params.get('error') == 'video_invalid_format' %}
        <div class="alert alert-error" style="margin-bottom: 1rem;">
            ‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ MP4, AVI, MOV, MKV –∏–ª–∏ WEBM.
        </div>
        {% endif %}
        
        <form method="POST" action="/advertiser/upload-video" enctype="multipart/form-data" id="videoUploadForm">
            <div class="form-group">
                <label for="video_file" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª–∏–∫ *
                </label>
                <input type="file" id="video_file" name="video_file" accept="video/*" required style="width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                <span style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem; display: block;">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, MKV (–º–∞–∫—Å. 100 –ú–ë)
                </span>
            </div>
            
            <div class="form-group" style="margin-top: 1.5rem;">
                <label for="comment" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                    –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–æ–ª–∏–∫—É
                </label>
                <textarea id="comment" name="comment" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à —Ä–æ–ª–∏–∫, —É–∫–∞–∂–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–µ –¥–∞—Ç—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è, –ø–ª–æ—â–∞–¥–∫–∏ –∏ –¥—Ä—É–≥—É—é –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é..." style="width: 100%; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: inherit; resize: vertical;"></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary" style="margin-top: 1rem; width: 100%;" id="submitBtn">
                üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–æ–ª–∏–∫ –Ω–∞ content@xk-media.ru
            </button>
        </form>
    </div>
</div>

<!-- –¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ -->
<div class="card" style="margin-top: 1.5rem; background: linear-gradient(135deg, #1a1a2e, #16213e); padding: 1rem 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span style="font-size: 1.75rem;">üè∑Ô∏è</span>
            <div>
                <div style="font-weight: 700; font-size: 1.1rem;">–¢–∞—Ä–∏—Ñ: –ë–∞–∑–æ–≤—ã–π</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">7000 ‚ÇΩ/–º–µ—Å—è—Ü –∑–∞ 1 –¢–í-—ç–∫—Ä–∞–Ω</div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 1.5rem;">
            <div style="text-align: right;">
                <div style="font-size: 0.75rem; color: var(--text-muted);">–ö–æ–º–ø–∞–Ω–∏—è</div>
                <div style="font-weight: 500;">{{ user.company_name or '‚Äî' }}</div>
            </div>
            <a href="/advertiser/profile" class="btn btn-secondary btn-sm" style="padding: 0.4rem 0.75rem;">–ü—Ä–æ—Ñ–∏–ª—å</a>
        </div>
    </div>
</div>

<script>
document.getElementById('videoUploadForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    const fileInput = document.getElementById('video_file');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (100 –ú–ë)
    if (fileInput.files.length > 0) {
        const fileSize = fileInput.files[0].size;
        const maxSize = 100 * 1024 * 1024; // 100 –ú–ë
        
        if (fileSize > maxSize) {
            e.preventDefault();
            alert('–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 100 –ú–ë. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.');
            return false;
        }
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';
});
</script>
{% endblock %}
