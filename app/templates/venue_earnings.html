{% extends "base.html" %}

{% block title %}–î–æ—Ö–æ–¥—ã –∏ –≤—ã–ø–ª–∞—Ç—ã ‚Äî XK Media{% endblock %}

{% block logo %}
<a href="/venue" class="logo">
    <span class="logo-icon">üì∫</span>
    XK Media
</a>
{% endblock %}

{% block nav %}
<a href="/venue">–û–±–∑–æ—Ä</a>
<a href="/venue/tvs">–ú–æ–∏ –¢–í</a>
<a href="/venue/earnings" class="active">–î–æ—Ö–æ–¥—ã</a>
<a href="/venue/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
<form method="POST" action="/switch-role" style="display: inline-block; margin: 0;">
    <input type="hidden" name="role" value="advertiser">
    <button type="submit" class="btn btn-secondary btn-sm" style="background: rgba(0, 212, 255, 0.2); border-color: var(--accent); color: var(--accent);" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ –∫–∞–±–∏–Ω–µ—Ç —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è">üéØ –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</button>
</form>
<a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div>
        <h1>üí∞ –î–æ—Ö–æ–¥—ã –∏ –≤—ã–ø–ª–∞—Ç—ã</h1>
        <p class="subtitle">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤–∞—à–∏–º –¢–í</p>
    </div>
</div>

<nav class="tabs">
    <a href="/venue" class="tab">–û–±–∑–æ—Ä</a>
    <a href="/venue/tvs" class="tab">–ú–æ–∏ –¢–í</a>
    <a href="/venue/advertisers" class="tab">–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–∏</a>
    <a href="/venue/earnings" class="tab active">–î–æ—Ö–æ–¥—ã</a>
    <a href="/venue/documents" class="tab">–î–æ–∫—É–º–µ–Ω—Ç—ã</a>
    <a href="/venue/profile" class="tab">–ü—Ä–æ—Ñ–∏–ª—å</a>
</nav>

<!-- Stats -->
<div class="grid grid-4">
    <div class="card stat-card">
        <div class="stat-icon">üíµ</div>
        <div class="stat-value">{{ stats.total_earned }} ‚ÇΩ</div>
        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value">{{ stats.total_paid }} ‚ÇΩ</div>
        <div class="stat-label">–í—ã–ø–ª–∞—á–µ–Ω–æ</div>
    </div>
    <div class="card stat-card highlight">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-value">{{ stats.pending }} ‚ÇΩ</div>
        <div class="stat-label">–ö –≤—ã–ø–ª–∞—Ç–µ</div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-value">{{ stats.subscriptions_count }}</div>
        <div class="stat-label">–ü–æ–¥–ø–∏—Å–æ–∫ –≤—Å–µ–≥–æ</div>
    </div>
</div>

<div class="grid grid-2">
    <!-- Monthly Breakdown -->
    <div class="card">
        <div class="card-header">
            <h3>üìä –î–æ—Ö–æ–¥ –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
        </div>
        <div class="card-content">
            {% if monthly_breakdown %}
            <div class="monthly-chart">
                {% for month, data in monthly_breakdown[:6] %}
                <div class="month-bar">
                    <div class="month-label">{{ month }}</div>
                    <div class="month-bar-container">
                        {% set max_earnings = (monthly_breakdown | map(attribute='1') | map(attribute='earnings') | max) or 1 %}
                        <div class="month-bar-fill" style="width: {{ (data.earnings / max_earnings * 100) | int }}%"></div>
                    </div>
                    <div class="month-value">{{ "{:,.0f}".format(data.earnings).replace(",", " ") }} ‚ÇΩ</div>
                    <div class="month-count">{{ data.count }} –ø–æ–¥–ø.</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state-small">
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–æ—Ö–æ–¥–∞–º</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pending Payouts -->
    <div class="card">
        <div class="card-header">
            <h3>‚è≥ –û–∂–∏–¥–∞—é—Ç –≤—ã–ø–ª–∞—Ç—ã</h3>
        </div>
        <div class="card-content">
            {% if pending_payouts %}
            <div class="payouts-list">
                {% for payout in pending_payouts %}
                <div class="payout-item">
                    <div class="payout-period">
                        {{ payout.period_start.strftime("%d.%m") }} ‚Äî {{ payout.period_end.strftime("%d.%m.%Y") }}
                    </div>
                    <div class="payout-amount">{{ "{:,.0f}".format(payout.amount).replace(",", " ") }} ‚ÇΩ</div>
                    <div class="payout-status">
                        {% if payout.status == "processing" %}
                        <span class="badge badge-warning">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</span>
                        {% else %}
                        <span class="badge badge-info">–û–∂–∏–¥–∞–µ—Ç</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state-small">
                <p>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –≤—ã–ø–ª–∞—Ç</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tariff Info -->
<div class="card">
    <div class="card-header">
        <h3>üíé –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∞—Ä–∏—Ñ–∞—Ö</h3>
    </div>
    <div class="card-content">
        <div class="tariff-grid">
            <div class="tariff-item">
                <div class="tariff-icon">üñ•Ô∏è</div>
                <div class="tariff-details">
                    <div class="tariff-title">–¢–í –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞ XK Media</div>
                    <div class="tariff-desc">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ XK Media</div>
                </div>
                <div class="tariff-percent">60%</div>
            </div>
            <div class="tariff-item highlight">
                <div class="tariff-icon">üì∫</div>
                <div class="tariff-details">
                    <div class="tariff-title">–°–≤–æ—ë –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</div>
                    <div class="tariff-desc">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–∞—à –¢–í-—ç–∫—Ä–∞–Ω</div>
                </div>
                <div class="tariff-percent">70%</div>
            </div>
        </div>
        <p class="tariff-note">
            –í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è –ø–æ –∏—Ç–æ–≥–∞–º –æ—Ç—á—ë—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (–º–µ—Å—è—Ü) –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã –æ—Ç —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π.
        </p>
    </div>
</div>

<!-- Recent Subscriptions -->
<div class="card">
    <div class="card-header">
        <h3>üìÖ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
    </div>
    <div class="card-content">
        {% if subscriptions %}
        <table class="table">
            <thead>
                <tr>
                    <th>–¢–í</th>
                    <th>–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</th>
                    <th>–ü–µ—Ä–∏–æ–¥</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                    <th>–í–∞—à–∞ –¥–æ–ª—è</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for sub in subscriptions %}
                <tr>
                    <td>{{ sub.tv.name if sub.tv else "‚Äî" }}</td>
                    <td>{{ sub.advertiser.company_name or sub.advertiser.email if sub.advertiser else "‚Äî" }}</td>
                    <td>{{ sub.start_date.strftime("%d.%m") }} ‚Äî {{ sub.end_date.strftime("%d.%m.%Y") }}</td>
                    <td>{{ "{:,.0f}".format(sub.price).replace(",", " ") }} ‚ÇΩ</td>
                    <td class="amount">{{ "{:,.0f}".format(sub.venue_payout or 0).replace(",", " ") }} ‚ÇΩ</td>
                    <td>
                        {% set today = sub.start_date.__class__.today() %}
                        {% if sub.start_date <= today <= sub.end_date %}
                        <span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% elif today < sub.start_date %}
                        <span class="badge badge-info">–û–∂–∏–¥–∞–µ—Ç</span>
                        {% else %}
                        <span class="badge badge-secondary">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state-small">
            <p>–ù–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Completed Payouts -->
<div class="card">
    <div class="card-header">
        <h3>‚úÖ –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç</h3>
    </div>
    <div class="card-content">
        {% if completed_payouts %}
        <table class="table">
            <thead>
                <tr>
                    <th>–ü–µ—Ä–∏–æ–¥</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–î–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã</th>
                </tr>
            </thead>
            <tbody>
                {% for payout in completed_payouts %}
                <tr>
                    <td>{{ payout.period_start.strftime("%d.%m") }} ‚Äî {{ payout.period_end.strftime("%d.%m.%Y") }}</td>
                    <td class="amount">{{ "{:,.0f}".format(payout.amount).replace(",", " ") }} ‚ÇΩ</td>
                    <td>{{ payout.paid_at.strftime("%d.%m.%Y") if payout.paid_at else "‚Äî" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state-small">
            <p>–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç –ø—É—Å—Ç–∞</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
.monthly-chart {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.month-bar {
    display: grid;
    grid-template-columns: 80px 1fr 100px 60px;
    gap: 1rem;
    align-items: center;
}

.month-label {
    font-weight: 500;
    color: var(--text-secondary);
}

.month-bar-container {
    height: 24px;
    background: var(--bg-secondary);
    border-radius: 4px;
    overflow: hidden;
}

.month-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent) 0%, #ff6b8a 100%);
    border-radius: 4px;
    min-width: 4px;
}

.month-value {
    font-weight: 600;
    text-align: right;
}

.month-count {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.payouts-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.payout-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.payout-period {
    flex: 1;
}

.payout-amount {
    font-weight: 700;
    font-size: 1.1rem;
}

.tariff-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.tariff-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
}

.tariff-item.highlight {
    border-color: var(--accent);
    background: rgba(233, 69, 96, 0.05);
}

.tariff-icon {
    font-size: 2rem;
}

.tariff-details {
    flex: 1;
}

.tariff-title {
    font-weight: 600;
}

.tariff-desc {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.tariff-percent {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent);
}

.tariff-note {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

@media (max-width: 768px) {
    .month-bar {
        grid-template-columns: 60px 1fr 80px;
    }
    
    .month-count {
        display: none;
    }
    
    .tariff-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
