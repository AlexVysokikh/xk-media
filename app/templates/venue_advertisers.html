{% extends "base.html" %}

{% block title %}–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–∏ ‚Äî XK Media{% endblock %}

{% block logo %}
<a href="/venue" class="logo">
    <span class="logo-icon">üì∫</span>
    XK Media
</a>
{% endblock %}

{% block nav %}
<a href="/venue">–û–±–∑–æ—Ä</a>
<a href="/venue/tvs">–ú–æ–∏ –¢–í</a>
<a href="/venue/earnings">–î–æ—Ö–æ–¥—ã</a>
<a href="/venue/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
<form method="POST" action="/switch-role" style="display: inline-block; margin: 0;">
    <input type="hidden" name="role" value="advertiser">
    <button type="submit" class="btn btn-secondary btn-sm" style="background: rgba(0, 212, 255, 0.2); border-color: var(--accent); color: var(--accent);" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ –∫–∞–±–∏–Ω–µ—Ç —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è">üéØ –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</button>
</form>
<a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div>
        <h1>üì¢ –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–∏</h1>
        <p class="subtitle">–ö—Ç–æ —Ä–∞–∑–º–µ—â–∞–µ—Ç —Ä–µ–∫–ª–∞–º—É –Ω–∞ –≤–∞—à–∏—Ö –¢–í</p>
    </div>
</div>

<nav class="tabs">
    <a href="/venue" class="tab">–û–±–∑–æ—Ä</a>
    <a href="/venue/tvs" class="tab">–ú–æ–∏ –¢–í</a>
    <a href="/venue/advertisers" class="tab active">–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–∏</a>
    <a href="/venue/earnings" class="tab">–î–æ—Ö–æ–¥—ã</a>
    <a href="/venue/documents" class="tab">–î–æ–∫—É–º–µ–Ω—Ç—ã</a>
    <a href="/venue/profile" class="tab">–ü—Ä–æ—Ñ–∏–ª—å</a>
</nav>

<!-- Stats -->
<div class="grid grid-3">
    <div class="card stat-card">
        <div class="stat-icon">üì¢</div>
        <div class="stat-value">{{ advertiser_data | list | length }}</div>
        <div class="stat-label">–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π</div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon">üíµ</div>
        <div class="stat-value">{{ total_revenue }} ‚ÇΩ</div>
        <div class="stat-label">–û–±—â–∏–π –æ–±–æ—Ä–æ—Ç</div>
    </div>
    <div class="card stat-card highlight">
        <div class="stat-icon">üí∞</div>
        <div class="stat-value">{{ total_venue_share }} ‚ÇΩ</div>
        <div class="stat-label">–í–∞—à–∞ –¥–æ–ª—è</div>
    </div>
</div>

<!-- Filter by TV -->
{% if tvs | length > 1 %}
<div class="card filter-card">
    <div class="filter-row">
        <span class="filter-label">–§–∏–ª—å—Ç—Ä –ø–æ –¢–í:</span>
        <div class="filter-buttons">
            <a href="/venue/advertisers" class="btn btn-sm {{ 'btn-primary' if not selected_tv_id else 'btn-outline' }}">–í—Å–µ</a>
            {% for tv in tvs %}
            <a href="/venue/advertisers?tv_id={{ tv.id }}" class="btn btn-sm {{ 'btn-primary' if selected_tv_id == tv.id else 'btn-outline' }}">{{ tv.name }}</a>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Advertisers Table -->
<div class="card">
    <div class="card-header">
        <h3>üìã –°–ø–∏—Å–æ–∫ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π</h3>
    </div>
    <div class="card-content">
        {% if advertiser_data | list | length > 0 %}
        <div class="advertisers-list">
            {% for data in advertiser_data %}
            <div class="advertiser-card">
                <div class="advertiser-header">
                    <div class="advertiser-info">
                        {% if data.advertiser.logo_url %}
                        <img src="{{ data.advertiser.logo_url }}" alt="" class="advertiser-logo">
                        {% else %}
                        <div class="advertiser-logo-placeholder">{{ (data.advertiser.company_name or data.advertiser.email)[0].upper() }}</div>
                        {% endif %}
                        <div>
                            <div class="advertiser-name">{{ data.advertiser.company_name or data.advertiser.email }}</div>
                            {% if data.advertiser.website %}
                            <a href="{{ data.advertiser.website }}" target="_blank" class="advertiser-website">{{ data.advertiser.website }}</a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="advertiser-tvs">
                        {% for tv_name in data.tv_names %}
                        <span class="badge badge-info">{{ tv_name }}</span>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="advertiser-stats">
                    <div class="advertiser-stat">
                        <div class="advertiser-stat-value">{{ data.subscriptions | length }}</div>
                        <div class="advertiser-stat-label">–ü–æ–¥–ø–∏—Å–æ–∫</div>
                    </div>
                    <div class="advertiser-stat">
                        <div class="advertiser-stat-value">{{ "{:,.0f}".format(data.total_paid).replace(",", " ") }} ‚ÇΩ</div>
                        <div class="advertiser-stat-label">–û–ø–ª–∞—á–µ–Ω–æ</div>
                    </div>
                    <div class="advertiser-stat highlight">
                        <div class="advertiser-stat-value">{{ "{:,.0f}".format(data.venue_share).replace(",", " ") }} ‚ÇΩ</div>
                        <div class="advertiser-stat-label">–í–∞—à–∞ –¥–æ–ª—è</div>
                    </div>
                </div>
                
                {% if data.subscriptions %}
                <div class="advertiser-subs">
                    <div class="subs-header">–ü–æ–¥–ø–∏—Å–∫–∏:</div>
                    {% for sub in data.subscriptions[:3] %}
                    <div class="sub-row">
                        <span class="sub-tv">{{ sub.tv.name if sub.tv else "‚Äî" }}</span>
                        <span class="sub-period">{{ sub.start_date.strftime("%d.%m") }} ‚Äî {{ sub.end_date.strftime("%d.%m.%Y") }}</span>
                        <span class="sub-amount">{{ "{:,.0f}".format(sub.venue_payout or 0).replace(",", " ") }} ‚ÇΩ</span>
                        {% set today = sub.start_date.__class__.today() %}
                        {% if sub.start_date <= today <= sub.end_date %}
                        <span class="badge badge-success badge-sm">–ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% elif today < sub.start_date %}
                        <span class="badge badge-info badge-sm">–û–∂–∏–¥–∞–µ—Ç</span>
                        {% else %}
                        <span class="badge badge-secondary badge-sm">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% if data.subscriptions | length > 3 %}
                    <div class="sub-more">+ –µ—â—ë {{ data.subscriptions | length - 3 }} –ø–æ–¥–ø–∏—Å–æ–∫</div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üì¢</div>
            <p>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π –Ω–∞ –≤–∞—à–∏—Ö –¢–í</p>
            <p class="text-secondary">–û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö —Ä–∞–∑–º–µ—â–µ–Ω–∏–π</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Active Links -->
{% if links %}
<div class="card">
    <div class="card-header">
        <h3>üîó –ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
    </div>
    <div class="card-content">
        <table class="table">
            <thead>
                <tr>
                    <th>–¢–í</th>
                    <th>–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</th>
                    <th>–†–µ–∫–ª–∞–º–∞</th>
                    <th>–ü–æ–∫–∞–∑—ã</th>
                    <th>–ü–µ—Ä–µ—Ö–æ–¥—ã</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for link in links %}
                <tr>
                    <td>{{ link.tv.name if link.tv else "‚Äî" }}</td>
                    <td>{{ link.advertiser_name or "‚Äî" }}</td>
                    <td>
                        <strong>{{ link.title }}</strong>
                        {% if link.description %}
                        <br><span class="text-secondary">{{ link.description[:50] }}...</span>
                        {% endif %}
                    </td>
                    <td>{{ "{:,}".format(link.impressions or 0).replace(",", " ") }}</td>
                    <td>{{ link.clicks or 0 }}</td>
                    <td>
                        <span class="badge {{ 'badge-success' if link.is_active else 'badge-secondary' }}">
                            {{ "–ê–∫—Ç–∏–≤–Ω–∞" if link.is_active else "–ù–µ–∞–∫—Ç–∏–≤–Ω–∞" }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<style>
.filter-card {
    padding: 1rem 1.5rem;
}

.filter-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.filter-label {
    font-weight: 500;
}

.filter-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.advertisers-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.advertiser-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
}

.advertiser-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.advertiser-info {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.advertiser-logo {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    object-fit: cover;
}

.advertiser-logo-placeholder {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    background: var(--accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: 700;
}

.advertiser-name {
    font-weight: 600;
    font-size: 1.1rem;
}

.advertiser-website {
    font-size: 0.85rem;
    color: var(--accent);
}

.advertiser-tvs {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.advertiser-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-card);
    border-radius: 8px;
    margin-bottom: 1rem;
}

.advertiser-stat {
    text-align: center;
}

.advertiser-stat.highlight {
    background: rgba(233, 69, 96, 0.1);
    border-radius: 8px;
    padding: 0.5rem;
}

.advertiser-stat-value {
    font-size: 1.1rem;
    font-weight: 700;
}

.advertiser-stat.highlight .advertiser-stat-value {
    color: var(--accent);
}

.advertiser-stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.advertiser-subs {
    background: var(--bg-card);
    border-radius: 8px;
    padding: 1rem;
}

.subs-header {
    font-weight: 500;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
}

.sub-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
}

.sub-row:last-child {
    border-bottom: none;
}

.sub-tv {
    font-weight: 500;
    min-width: 120px;
}

.sub-period {
    color: var(--text-secondary);
    flex: 1;
}

.sub-amount {
    font-weight: 600;
    color: var(--accent);
}

.sub-more {
    padding-top: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.badge-sm {
    padding: 0.125rem 0.5rem;
    font-size: 0.75rem;
}

@media (max-width: 768px) {
    .advertiser-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .advertiser-stats {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .sub-row {
        flex-wrap: wrap;
    }
}
</style>
{% endblock %}
