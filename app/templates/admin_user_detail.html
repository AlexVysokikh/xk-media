{% extends "base.html" %}

{% block title %}{{ target_user.email }} ‚Äî –ê–¥–º–∏–Ω{% endblock %}

{% block logo %}
<a href="/admin" class="logo">
    <span class="logo-icon">üì∫</span>
    XK Media
</a>
{% endblock %}

{% block nav %}
<a href="/admin">–î–∞—à–±–æ—Ä–¥</a>
<a href="/admin/users" class="active">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
<a href="/admin/tvs">–≠–∫—Ä–∞–Ω—ã</a>
<a href="/admin/payments">–ü–ª–∞—Ç–µ–∂–∏</a>
<a href="/admin/payouts">–í—ã–ø–ª–∞—Ç—ã</a>
<a href="/admin/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
<a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
        <a href="/admin/users" style="color: var(--text-muted); font-size: 0.875rem;">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        <h1 class="page-title" style="margin-top: 0.5rem;">
            {{ target_user.first_name or '' }} {{ target_user.last_name or target_user.email }}
        </h1>
        <p class="page-subtitle">
            {% if target_user.role == 'advertiser' %}–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å{% elif target_user.role == 'venue' %}–ü–ª–æ—â–∞–¥–∫–∞{% else %}–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä{% endif %}
            ¬∑ ID #{{ target_user.id }}
        </p>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        {% if target_user.is_active %}
        <a href="/admin/user/{{ target_user.id }}/block" class="btn btn-secondary btn-sm" onclick="return confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</a>
        {% else %}
        <a href="/admin/user/{{ target_user.id }}/unblock" class="btn btn-primary btn-sm">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</a>
        {% endif %}
        {% if target_user.role != 'admin' %}
        <a href="/admin/user/{{ target_user.id }}/delete" class="btn btn-secondary btn-sm" style="color: var(--accent);" onclick="return confirm('–í–ù–ò–ú–ê–ù–ò–ï! –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –ø–æ–¥–ø–∏—Å–∫–∏, —Ä–µ–∫–ª–∞–º–Ω—ã–µ —Å—Å—ã–ª–∫–∏, –ø–ª–∞—Ç–µ–∂–∏. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')">üóë –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
        {% endif %}
    </div>
</div>

<div class="grid grid-2">
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        </div>
        <form method="POST" action="/admin/user/{{ target_user.id }}">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="email" value="{{ target_user.email }}" class="form-input" readonly>
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">–ò–º—è</label>
                    <input type="text" name="first_name" value="{{ target_user.first_name or '' }}" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" name="last_name" value="{{ target_user.last_name or '' }}" class="form-input">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" name="phone" value="{{ target_user.phone or '' }}" class="form-input" placeholder="+7 999 123-45-67">
            </div>
            <div class="form-group">
                <label class="form-label">–†–æ–ª—å</label>
                <select name="role" class="form-input">
                    <option value="advertiser" {% if target_user.role == 'advertiser' %}selected{% endif %}>–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</option>
                    <option value="venue" {% if target_user.role == 'venue' %}selected{% endif %}>–ü–ª–æ—â–∞–¥–∫–∞</option>
                    <option value="admin" {% if target_user.role == 'admin' %}selected{% endif %}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                </select>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="is_verified" {% if target_user.is_verified %}checked{% endif %}>
                    <span>–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</span>
                </label>
            </div>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>

    <!-- –î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üè¢ –î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏</h3>
        </div>
        <form method="POST" action="/admin/user/{{ target_user.id }}/company">
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
                <input type="text" name="company_name" value="{{ target_user.company_name or '' }}" class="form-input" placeholder="–û–û–û –†–µ–∫–ª–∞–º–Ω–æ–µ –ê–≥–µ–Ω—Ç—Å—Ç–≤–æ">
            </div>
            <div class="form-group">
                <label class="form-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" name="legal_name" value="{{ target_user.legal_name or '' }}" class="form-input" placeholder="–û–û–û ¬´–†–µ–∫–ª–∞–º–Ω–æ–µ –ê–≥–µ–Ω—Ç—Å—Ç–≤–æ¬ª">
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">–ò–ù–ù</label>
                    <input type="text" name="inn" value="{{ target_user.inn or '' }}" class="form-input" placeholder="1234567890" maxlength="12">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–ü–ü</label>
                    <input type="text" name="kpp" value="{{ target_user.kpp or '' }}" class="form-input" placeholder="123456789" maxlength="9">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</label>
                <input type="text" name="legal_address" value="{{ target_user.legal_address or '' }}" class="form-input" placeholder="–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 1">
            </div>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>

{% if target_user.role == 'advertiser' %}
<!-- –ë–∞–ª–∞–Ω—Å –∏ –ø–ª–∞—Ç–µ–∂–∏ -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title">üí∞ –ë–∞–ª–∞–Ω—Å –∏ –ø–ª–∞—Ç–µ–∂–∏</h3>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">
            {{ "%.0f"|format(target_user.balance or 0) }} ‚ÇΩ
        </div>
    </div>
    
    <!-- –†—É—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ -->
    <form method="POST" action="/admin/user/{{ target_user.id }}/add-balance" style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1.5rem;">
        <div class="form-group" style="margin: 0; flex: 1;">
            <label class="form-label">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤—Ä—É—á–Ω—É—é</label>
            <input type="number" name="amount" class="form-input" placeholder="1000" min="1" step="1" required>
        </div>
        <div class="form-group" style="margin: 0; flex: 2;">
            <input type="text" name="comment" class="form-input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        </div>
        <button type="submit" class="btn btn-primary">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
    </form>
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π -->
    <h4 style="margin-bottom: 1rem; color: var(--text-muted);">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h4>
    <table class="table">
        <thead>
            <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–°—É–º–º–∞</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody>
            {% for p in payments %}
            <tr>
                <td>{{ p.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                <td style="font-weight: 600;">{{ "%.0f"|format(p.amount) }} ‚ÇΩ</td>
                <td>{{ p.description or '‚Äî' }}</td>
                <td>
                    {% if p.status == 'succeeded' %}
                    <span class="badge badge-success">–û–ø–ª–∞—á–µ–Ω</span>
                    {% elif p.status == 'pending' or p.status == 'waiting' %}
                    <span class="badge badge-warning">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                    {% else %}
                    <span class="badge badge-danger">{{ p.status }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% if not payments %}
            <tr>
                <td colspan="4" style="text-align: center; color: var(--text-muted);">–ü–ª–∞—Ç–µ–∂–µ–π –Ω–µ—Ç</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –¢–í -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üì∫ –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –¢–í</h3>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>–¢–í</th>
                <th>–ú–µ—Å—Ç–æ</th>
                <th>–ü–µ—Ä–∏–æ–¥</th>
                <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody>
            {% for s in subscriptions %}
            <tr>
                <td>
                    <a href="/admin/tv/{{ s.tv.code }}">{{ s.tv.name }}</a>
                </td>
                <td>{{ s.tv.venue_name or s.tv.address or '‚Äî' }}</td>
                <td>{{ s.start_date.strftime('%d.%m.%Y') }} ‚Äî {{ s.end_date.strftime('%d.%m.%Y') }}</td>
                <td>{{ "%.0f"|format(s.price) }} ‚ÇΩ</td>
                <td>
                    {% if s.is_active %}
                    <span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                    {% else %}
                    <span class="badge badge-danger">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% if not subscriptions %}
            <tr>
                <td colspan="5" style="text-align: center; color: var(--text-muted);">–ü–æ–¥–ø–∏—Å–æ–∫ –Ω–µ—Ç</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endif %}

{% if target_user.role == 'venue' %}
<!-- –¢–í –ø–ª–æ—â–∞–¥–∫–∏ -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üì∫ –¢–í –ø–ª–æ—â–∞–¥–∫–∏</h3>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>–ö–æ–¥</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–ê–¥—Ä–µ—Å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for tv in owned_tvs %}
            <tr>
                <td><code>{{ tv.code }}</code></td>
                <td>{{ tv.name }}</td>
                <td>{{ tv.address or '‚Äî' }}</td>
                <td>
                    {% if tv.is_active %}
                    <span class="badge badge-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% else %}
                    <span class="badge badge-danger">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/admin/tv/{{ tv.code }}" class="btn btn-secondary btn-sm">–û—Ç–∫—Ä—ã—Ç—å</a>
                </td>
            </tr>
            {% endfor %}
            {% if not owned_tvs %}
            <tr>
                <td colspan="5" style="text-align: center; color: var(--text-muted);">–¢–í –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
