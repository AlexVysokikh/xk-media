{% extends "base.html" %}

{% block title %}{{ tv.name }} ‚Äî –ê–¥–º–∏–Ω{% endblock %}

{% block logo %}
<a href="/admin" class="logo">
    <span class="logo-icon">üì∫</span>
    XK Media
</a>
{% endblock %}

{% block nav %}
<a href="/admin">–î–∞—à–±–æ—Ä–¥</a>
<a href="/admin/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
<a href="/admin/tvs" class="active">–≠–∫—Ä–∞–Ω—ã</a>
<a href="/admin/payments">–ü–ª–∞—Ç–µ–∂–∏</a>
<a href="/admin/payouts">–í—ã–ø–ª–∞—Ç—ã</a>
<a href="/admin/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
<a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
        <a href="/admin/tvs" style="color: var(--text-muted); font-size: 0.875rem;">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        <h1 class="page-title" style="margin-top: 0.5rem;">üì∫ {{ tv.name }}</h1>
        <p class="page-subtitle">
            –ö–æ–¥: <code style="background: var(--secondary); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ tv.code }}</code>
            {% if tv.venue_name %} ¬∑ {{ tv.venue_name }}{% endif %}
        </p>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        <a href="/admin/tv/{{ tv.code }}/advertisers" class="btn btn-primary btn-sm">üì¢ –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–∏</a>
        <a href="/tv/{{ tv.code }}" target="_blank" class="btn btn-secondary btn-sm">üëÅ –ü—Ä–µ–≤—å—é</a>
        <a href="/admin/tv/{{ tv.code }}/delete" class="btn btn-secondary btn-sm" style="color: var(--accent);"
           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –¢–í?')">üóë –£–¥–∞–ª–∏—Ç—å</a>
    </div>
</div>

<!-- –§–æ—Ç–æ —ç–∫—Ä–∞–Ω–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
{% if tv.photo_url %}
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üì∑ –§–æ—Ç–æ —ç–∫—Ä–∞–Ω–∞</h3>
    </div>
    <div style="text-align: center; padding: 1rem;">
        <img src="{{ tv.photo_url }}" alt="–§–æ—Ç–æ –¢–í-—ç–∫—Ä–∞–Ω–∞" style="max-width: 100%; max-height: 400px; border-radius: 12px; object-fit: contain; border: 1px solid var(--border);">
    </div>
</div>
{% endif %}

<div class="grid grid-2">
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        </div>
        <form method="POST" action="/admin/tv/{{ tv.code }}" enctype="multipart/form-data">
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">–ö–æ–¥ –¢–í</label>
                    <input type="text" value="{{ tv.code }}" class="form-input" readonly style="opacity: 0.7;">
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –¢–í</label>
                    <input type="text" name="name" value="{{ tv.name }}" class="form-input" required>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</label>
                <input type="text" name="venue_name" value="{{ tv.venue_name or '' }}" class="form-input" placeholder="–ö–æ—Ñ–µ–π–Ω—è ¬´–†–∞—Å—Å–≤–µ—Ç¬ª">
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select name="category" class="form-input">
                        {% for key, val in categories.items() %}
                        <option value="{{ key }}" {% if tv.category == key %}selected{% endif %}>{{ val }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</label>
                    <select name="target_audience" class="form-input">
                        {% for key, val in audiences.items() %}
                        <option value="{{ key }}" {% if tv.target_audience == key %}selected{% endif %}>{{ val }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea name="description" class="form-input" rows="2">{{ tv.description or '' }}</textarea>
            </div>
            
            <!-- –§–æ—Ç–æ —ç–∫—Ä–∞–Ω–∞ -->
            <div class="form-group">
                <label class="form-label">–§–æ—Ç–æ —ç–∫—Ä–∞–Ω–∞</label>
                {% if tv.photo_url %}
                <div style="margin-bottom: 0.75rem;">
                    <img src="{{ tv.photo_url }}" alt="–§–æ—Ç–æ –¢–í-—ç–∫—Ä–∞–Ω–∞" style="max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border);">
                </div>
                {% endif %}
                <input type="url" name="photo_url" value="{{ tv.photo_url or '' }}" class="form-input" placeholder="https://example.com/tv-photo.jpg">
                <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">URL —Ñ–æ—Ç–æ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –Ω–∏–∂–µ</small>
            </div>
            <div class="form-group">
                <label class="form-label">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª</label>
                <input type="file" name="photo_file" accept="image/*" class="form-input">
                <small style="color: var(--text-muted);">JPG, PNG, –¥–æ 5 –ú–ë</small>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="is_active" {% if tv.is_active %}checked{% endif %}>
                    <span>–ê–∫—Ç–∏–≤–µ–Ω</span>
                </label>
            </div>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>

    <!-- –ê–¥—Ä–µ—Å –∏ —é—Ä. –ª–∏—Ü–æ -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üìç –ê–¥—Ä–µ—Å –∏ —é—Ä. –ª–∏—Ü–æ</h3>
        </div>
        <form method="POST" action="/admin/tv/{{ tv.code }}/location">
            <div class="form-group">
                <label class="form-label">–ì–æ—Ä–æ–¥</label>
                <input type="text" name="city" value="{{ tv.city or '' }}" class="form-input" placeholder="–ú–æ—Å–∫–≤–∞">
            </div>
            <div class="form-group">
                <label class="form-label">–ê–¥—Ä–µ—Å</label>
                <input type="text" name="address" value="{{ tv.address or '' }}" class="form-input" placeholder="—É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, –¥. 1">
            </div>
            
            <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0;">
            
            <div class="form-group">
                <label class="form-label">–Æ—Ä. –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" name="legal_name" value="{{ tv.legal_name or '' }}" class="form-input" placeholder="–û–û–û ¬´–†–∞—Å—Å–≤–µ—Ç¬ª">
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">–ò–ù–ù</label>
                    <input type="text" name="inn" value="{{ tv.inn or '' }}" class="form-input" maxlength="12">
                </div>
                <div class="form-group">
                    <label class="form-label">% –≤—ã–ø–ª–∞—Ç—ã</label>
                    <input type="number" name="revenue_share" value="{{ tv.revenue_share or 30 }}" class="form-input" min="0" max="100">
                </div>
            </div>
            
            <hr style="border: none; border-top: 1px solid var(--border); margin: 1.5rem 0;">
            
            <div class="form-group">
                <label class="form-label">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
                <input type="text" name="contact_person" value="{{ tv.contact_person or '' }}" class="form-input">
            </div>
            <div class="grid grid-2">
                <div class="form-group">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" name="contact_phone" value="{{ tv.contact_phone or '' }}" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="contact_email" value="{{ tv.contact_email or '' }}" class="form-input">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>

<!-- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–ª–æ—â–∞–¥–∫–µ -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üè¢ –í–ª–∞–¥–µ–ª–µ—Ü (–ø–ª–æ—â–∞–¥–∫–∞)</h3>
    </div>
    <form method="POST" action="/admin/tv/{{ tv.code }}/owner" style="display: flex; gap: 1rem; align-items: flex-end;">
        <div class="form-group" style="margin: 0; flex: 1;">
            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–æ—â–∞–¥–∫—É</label>
            <select name="venue_id" class="form-input">
                <option value="">‚Äî –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω ‚Äî</option>
                {% for v in venues %}
                <option value="{{ v.id }}" {% if tv.venue_id == v.id %}selected{% endif %}>
                    {{ v.company_name or v.email }} {% if v.inn %}(–ò–ù–ù: {{ v.inn }}){% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
</div>

<!-- –†–µ–∫–ª–∞–º–Ω—ã–µ —Å—Å—ã–ª–∫–∏ -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üîó –†–µ–∫–ª–∞–º–Ω—ã–µ —Å—Å—ã–ª–∫–∏ ({{ links|length }})</h3>
    </div>
    
    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <form method="POST" action="/admin/tv/{{ tv.code }}/add-link" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border);">
        <div class="form-group" style="margin: 0; min-width: 150px;">
            <label class="form-label">–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</label>
            <select name="advertiser_id" class="form-input" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                {% for a in advertisers %}
                <option value="{{ a.id }}">{{ a.email }}{% if a.company_name %} ({{ a.company_name }}){% endif %}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
            <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
            <input type="text" name="title" class="form-input" placeholder="–ê–∫—Ü–∏—è -20%" required>
        </div>
        <div class="form-group" style="margin: 0; flex: 2; min-width: 200px;">
            <label class="form-label">URL</label>
            <input type="url" name="url" class="form-input" placeholder="https://example.com" required>
        </div>
        <div class="form-group" style="margin: 0; flex: 1; min-width: 150px;">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <input type="text" name="description" class="form-input" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ">
        </div>
        <button type="submit" class="btn btn-primary" style="align-self: flex-end;">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </form>
    
    <!-- –°–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫ -->
    <table class="table">
        <thead>
            <tr>
                <th>#</th>
                <th>–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</th>
                <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫ / URL</th>
                <th>–ö–ª–∏–∫–∏</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for link in links %}
            <tr>
                <td>{{ link.position + 1 }}</td>
                <td>{{ link.advertiser.email if link.advertiser else (link.advertiser_name or '‚Äî') }}</td>
                <td>
                    <div style="font-weight: 600;">{{ link.title }}</div>
                    <a href="{{ link.url }}" target="_blank" style="font-size: 0.75rem;">{{ link.url[:50] }}...</a>
                    {% if link.description %}
                    <div style="font-size: 0.75rem; color: var(--text-muted);">{{ link.description }}</div>
                    {% endif %}
                </td>
                <td style="font-weight: 600;">{{ link.clicks }}</td>
                <td>
                    {% if link.is_active %}
                    <span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                    {% else %}
                    <span class="badge badge-danger">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                    {% endif %}
                </td>
                <td>
                    <a href="/admin/tv/{{ tv.code }}/link/{{ link.id }}/delete" 
                       class="btn btn-secondary btn-sm" style="color: var(--accent);"
                       onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É?')">üóë</a>
                </td>
            </tr>
            {% endfor %}
            {% if not links %}
            <tr>
                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                    –°—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –≤—ã—à–µ.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —ç—Ç–æ—Ç –¢–í -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üìÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å</th>
                <th>–ü–µ—Ä–∏–æ–¥</th>
                <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                <th>–í—ã–ø–ª–∞—Ç–∞ –ø–ª–æ—â–∞–¥–∫–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody>
            {% for s in subscriptions %}
            <tr>
                <td>
                    <a href="/admin/user/{{ s.advertiser_id }}">{{ s.advertiser.email if s.advertiser else '‚Äî' }}</a>
                </td>
                <td>{{ s.start_date.strftime('%d.%m.%Y') }} ‚Äî {{ s.end_date.strftime('%d.%m.%Y') }}</td>
                <td>{{ "%.0f"|format(s.price) }} ‚ÇΩ</td>
                <td>{{ "%.0f"|format(s.venue_payout) }} ‚ÇΩ</td>
                <td>
                    {% if s.is_active %}
                    <span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                    {% else %}
                    <span class="badge badge-danger">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% if not subscriptions %}
            <tr>
                <td colspan="5" style="text-align: center; color: var(--text-muted);">–ü–æ–¥–ø–∏—Å–æ–∫ –Ω–µ—Ç</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}
