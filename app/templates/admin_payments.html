{% extends "base.html" %}

{% block title %}–ü–ª–∞—Ç–µ–∂–∏ ‚Äî –ê–¥–º–∏–Ω{% endblock %}

{% block logo %}
<a href="/admin" class="logo">
    <span class="logo-icon">üì∫</span>
    XK Media
</a>
{% endblock %}

{% block nav %}
<a href="/admin">–î–∞—à–±–æ—Ä–¥</a>
<a href="/admin/users">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
<a href="/admin/tvs">–≠–∫—Ä–∞–Ω—ã</a>
<a href="/admin/payments" class="active">–ü–ª–∞—Ç–µ–∂–∏</a>
<a href="/admin/payouts">–í—ã–ø–ª–∞—Ç—ã</a>
<a href="/admin/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
<a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üí≥ –ü–ª–∞—Ç–µ–∂–∏</h1>
    <p class="page-subtitle">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π</p>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="grid grid-3" style="margin-bottom: 1.5rem;">
    <div class="card stat-card">
        <div class="stat-value">{{ stats.total_revenue }} ‚ÇΩ</div>
        <div class="stat-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥</div>
    </div>
    <div class="card stat-card">
        <div class="stat-value">{{ stats.month_revenue }} ‚ÇΩ</div>
        <div class="stat-label">–ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</div>
    </div>
    <div class="card stat-card">
        <div class="stat-value">{{ stats.pending_count }}</div>
        <div class="stat-label">–û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã</div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <a href="/admin/payments" class="btn {% if not status_filter %}btn-primary{% else %}btn-secondary{% endif %} btn-sm">–í—Å–µ</a>
        <a href="/admin/payments?status=succeeded" class="btn {% if status_filter == 'succeeded' %}btn-primary{% else %}btn-secondary{% endif %} btn-sm">‚úì –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ</a>
        <a href="/admin/payments?status=pending" class="btn {% if status_filter == 'pending' %}btn-primary{% else %}btn-secondary{% endif %} btn-sm">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ</a>
        <a href="/admin/payments?status=failed" class="btn {% if status_filter == 'failed' %}btn-primary{% else %}btn-secondary{% endif %} btn-sm">‚úó –û—à–∏–±–∫–∏</a>
        <div style="flex: 1;"></div>
        <span style="color: var(--text-muted);">–ü–æ–∫–∞–∑–∞–Ω–æ: {{ payments|length }}</span>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π -->
<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>–î–∞—Ç–∞</th>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–°—É–º–º–∞</th>
                <th>–¢–∏–ø</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for p in payments %}
            <tr>
                <td>#{{ p.id }}</td>
                <td>
                    <div>{{ p.created_at.strftime('%d.%m.%Y') }}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">{{ p.created_at.strftime('%H:%M') }}</div>
                </td>
                <td>
                    {% if p.user %}
                    <a href="/admin/user/{{ p.user.id }}">
                        {{ p.user.company_name or p.user.first_name or p.user.email }}
                    </a>
                    {% else %}
                    <span style="color: var(--text-muted);">ID: {{ p.user_id }}</span>
                    {% endif %}
                </td>
                <td style="font-weight: 700; font-size: 1.125rem;">
                    {{ "%.0f"|format(p.amount) }} ‚ÇΩ
                </td>
                <td>
                    {% if p.payment_type == 'subscription' %}
                    <span class="badge badge-info">–ü–æ–¥–ø–∏—Å–∫–∞</span>
                    {% else %}
                    <span class="badge badge-warning">–ë–∞–ª–∞–Ω—Å</span>
                    {% endif %}
                </td>
                <td style="max-width: 200px; font-size: 0.875rem;">
                    {{ p.description or '‚Äî' }}
                </td>
                <td>
                    {% if p.status == 'succeeded' %}
                    <span class="badge badge-success">–û–ø–ª–∞—á–µ–Ω</span>
                    {% if p.paid_at %}
                    <div style="font-size: 0.7rem; color: var(--text-muted);">{{ p.paid_at.strftime('%d.%m %H:%M') }}</div>
                    {% endif %}
                    {% elif p.status == 'pending' %}
                    <span class="badge badge-warning">–°–æ–∑–¥–∞–Ω</span>
                    {% elif p.status == 'waiting' %}
                    <span class="badge badge-warning">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                    {% elif p.status == 'canceled' %}
                    <span class="badge badge-danger">–û—Ç–º–µ–Ω—ë–Ω</span>
                    {% else %}
                    <span class="badge badge-danger">{{ p.status }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if p.status == 'pending' or p.status == 'waiting' %}
                    <a href="/admin/payment/{{ p.id }}/confirm" class="btn btn-primary btn-sm" 
                       onclick="return confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É?')">‚úì</a>
                    <a href="/admin/payment/{{ p.id }}/cancel" class="btn btn-secondary btn-sm"
                       onclick="return confirm('–û—Ç–º–µ–Ω–∏—Ç—å –ø–ª–∞—Ç—ë–∂?')">‚úó</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% if not payments %}
            <tr>
                <td colspan="8" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                    –ü–ª–∞—Ç–µ–∂–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}
