{% extends "base.html" %}

{% block title %}–ü–æ–¥–ø–∏—Å–∫–∏ ‚Äî XK Media{% endblock %}

{% block head %}
<style>
    .balance-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, var(--accent), #ff6b6b);
        border-radius: 12px;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.5rem;
        color: white;
    }
    .balance-amount {
        font-size: 2rem;
        font-weight: 700;
    }
    .balance-label {
        font-size: 0.85rem;
        opacity: 0.9;
    }
    .tariff-card {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid var(--accent);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1.5rem;
    }
    .tariff-name {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .tariff-price {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--accent);
    }
    .tariff-price span {
        font-size: 1rem;
        color: var(--text-muted);
    }
    .subscription-card {
        background: var(--secondary);
        border-radius: 10px;
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        display: grid;
        grid-template-columns: 2fr 1fr 1fr auto;
        gap: 1rem;
        align-items: center;
        border-left: 4px solid var(--success);
    }
    .subscription-card.expired {
        border-left-color: var(--text-muted);
        opacity: 0.7;
    }
    .sub-tv .name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    .sub-tv .venue {
        font-size: 0.8rem;
        color: var(--text-muted);
    }
    .sub-dates {
        font-size: 0.85rem;
    }
    .sub-dates .days-left {
        font-weight: 600;
        color: var(--success);
    }
    .sub-price {
        text-align: right;
    }
    .sub-price .amount {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--accent);
    }
    .tv-select-card {
        background: var(--secondary);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .tv-select-card:hover {
        border-color: var(--accent);
        background: var(--card-bg);
    }
    .tv-select-card.selected {
        border-color: var(--accent);
        background: rgba(233, 69, 96, 0.1);
    }
    @media (max-width: 768px) {
        .subscription-card {
            grid-template-columns: 1fr;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block logo %}
<a href="/advertiser" class="logo">
    <span class="logo-icon">üì∫</span>
    XK Media
</a>
{% endblock %}

{% block nav %}
<a href="/advertiser">–î–∞—à–±–æ—Ä–¥</a>
<a href="/advertiser/stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
<a href="/advertiser/subscriptions" class="active">–ü–æ–¥–ø–∏—Å–∫–∏</a>
<a href="/advertiser/payments">–ü–ª–∞—Ç–µ–∂–∏</a>
<a href="/advertiser/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
<form method="POST" action="/switch-role" style="display: inline-block; margin: 0;">
    <input type="hidden" name="role" value="venue">
    <button type="submit" class="btn btn-secondary btn-sm" style="background: rgba(131, 56, 236, 0.2); border-color: var(--accent-tertiary); color: var(--accent-tertiary);" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ –∫–∞–±–∏–Ω–µ—Ç –ø–ª–æ—â–∞–¥–∫–∏">üì∫ –ü–ª–æ—â–∞–¥–∫–∞</button>
</form>
<a href="/logout" class="btn btn-secondary btn-sm">–í—ã–π—Ç–∏</a>
{% endblock %}

{% block content %}
<div class="page-header" style="margin-bottom: 1.5rem;">
    <h1 class="page-title">üìÖ –ü–æ–¥–ø–∏—Å–∫–∏ –∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h1>
    <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è–º–∏ –Ω–∞ –¢–í-—ç–∫—Ä–∞–Ω–∞—Ö</p>
</div>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if success %}
<div class="alert alert-success">{{ success }}</div>
{% endif %}

<!-- –ë–∞–ª–∞–Ω—Å -->
<div class="balance-bar">
    <div>
        <div class="balance-label">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
        <div class="balance-amount">{{ balance }} ‚ÇΩ</div>
    </div>
    <a href="/advertiser/payments" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: none;">
        + –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
    </a>
</div>

<div class="grid grid-2">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏ -->
    <div>
        <!-- –¢–∞—Ä–∏—Ñ -->
        <div class="tariff-card">
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem;">–í–ê–® –¢–ê–†–ò–§</div>
            <div class="tariff-name">üè∑Ô∏è –ë–∞–∑–æ–≤—ã–π</div>
            <div class="tariff-price">7000 ‚ÇΩ <span>/ –º–µ—Å—è—Ü</span></div>
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">
                –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º—ã –Ω–∞ 1 –¢–í-—ç–∫—Ä–∞–Ω–µ
            </div>
        </div>
        
        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <h3 class="card-title">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ ({{ active_subscriptions|length }})</h3>
            </div>
            
            {% if active_subscriptions %}
            {% for s in active_subscriptions %}
            <div class="subscription-card">
                <div class="sub-tv">
                    <div class="name">{{ s.tv.name }}</div>
                    <div class="venue">üìç {{ s.tv.venue_name or s.tv.address or '‚Äî' }}</div>
                </div>
                <div class="sub-dates">
                    <div>{{ s.start_date.strftime('%d.%m') }} ‚Äî {{ s.end_date.strftime('%d.%m.%Y') }}</div>
                    <div class="days-left">–û—Å—Ç–∞–ª–æ—Å—å {{ s.days_left }} –¥–Ω.</div>
                </div>
                <div class="sub-price">
                    <div class="amount">{{ "%.0f"|format(s.price) }} ‚ÇΩ</div>
                    <span class="badge badge-success" style="font-size: 0.65rem;">–ê–∫—Ç–∏–≤–Ω–∞</span>
                </div>
                <div>
                    <a href="/advertiser/subscriptions/{{ s.id }}/extend" class="btn btn-secondary btn-sm">–ü—Ä–æ–¥–ª–∏—Ç—å</a>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                <p>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</p>
                <p style="font-size: 0.85rem;">–û—Ñ–æ—Ä–º–∏—Ç–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ –¢–í-—ç–∫—Ä–∞–Ω–µ —Å–ø—Ä–∞–≤–∞ ‚Üí</p>
            </div>
            {% endif %}
        </div>
        
        <!-- –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ -->
        {% if expired_subscriptions %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title" style="color: var(--text-muted);">üìú –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ ({{ expired_subscriptions|length }})</h3>
            </div>
            {% for s in expired_subscriptions %}
            <div class="subscription-card expired">
                <div class="sub-tv">
                    <div class="name">{{ s.tv.name }}</div>
                    <div class="venue">{{ s.tv.venue_name or '‚Äî' }}</div>
                </div>
                <div class="sub-dates">
                    {{ s.start_date.strftime('%d.%m') }} ‚Äî {{ s.end_date.strftime('%d.%m.%Y') }}
                </div>
                <div class="sub-price">
                    <div class="amount" style="color: var(--text-muted);">{{ "%.0f"|format(s.price) }} ‚ÇΩ</div>
                    <span class="badge badge-danger" style="font-size: 0.65rem;">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                </div>
                <div>
                    <a href="/advertiser/subscriptions?renew={{ s.tv_id }}" class="btn btn-secondary btn-sm">–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">‚ûï –û—Ñ–æ—Ä–º–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ</h3>
        </div>
        
        <form method="POST" action="/advertiser/subscriptions/create" id="subscription-form">
            <div class="form-group">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –¢–í-—ç–∫—Ä–∞–Ω *</label>
                <select name="tv_id" class="form-input" required id="tv_select">
                    <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –¢–í ‚Äî</option>
                    {% for tv in available_tvs %}
                    <option value="{{ tv.id }}">{{ tv.name }} ‚Äî {{ tv.venue_name or tv.address or '–ë–µ–∑ –∞–¥—Ä–µ—Å–∞' }} {% if tv.city %}({{ tv.city }}){% endif %}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="grid grid-2" style="gap: 1rem;">
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ *</label>
                    <input type="date" name="start_date" id="start_date" class="form-input" required min="{{ today }}" value="{{ today }}" onchange="calculatePrice()">
                </div>
                <div class="form-group" style="margin-bottom: 0.75rem;">
                    <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è *</label>
                    <input type="date" name="end_date" id="end_date" class="form-input" required min="{{ today }}" onchange="calculatePrice()">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–∫–ª–∞–º—ã *</label>
                <input type="text" name="title" class="form-input" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–∏–¥–∫–∞ 20% –Ω–∞ –≤—Å—ë!">
            </div>
            
            <div class="form-group">
                <label class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∞–π—Ç *</label>
                <input type="url" name="url" class="form-input" required placeholder="https://your-site.ru/promo">
            </div>
            
            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea name="description" class="form-input" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
            </div>
            
            <!-- –†–∞—Å—á—ë—Ç -->
            <div style="background: var(--secondary); border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: var(--text-muted);">–¢–∞—Ä–∏—Ñ:</span>
                    <span>–ë–∞–∑–æ–≤—ã–π ‚Äî 7000 ‚ÇΩ/–º–µ—Å—è—Ü</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: var(--text-muted);">–î–Ω–µ–π:</span>
                    <span id="months_count">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 0.75rem; border-top: 1px solid var(--border);">
                    <span style="font-weight: 600;">–ö –æ–ø–ª–∞—Ç–µ:</span>
                    <span id="price_display" style="font-size: 1.5rem; font-weight: 700; color: var(--accent);">0 ‚ÇΩ</span>
                </div>
                <input type="hidden" name="price" id="price_input" value="0">
            </div>
            
            <div id="balance_warning" style="display: none; background: rgba(233, 69, 96, 0.1); border: 1px solid var(--accent); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.9rem; color: var(--accent);">
                ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. <a href="/advertiser/payments">–ü–æ–ø–æ–ª–Ω–∏—Ç—å ‚Üí</a>
            </div>
            
            <button type="submit" id="submit_btn" class="btn btn-primary btn-lg" style="width: 100%;">
                –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
            </button>
        </form>
    </div>
</div>

<!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –¢–í -->
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">üì∫ –î–æ—Å—Ç—É–ø–Ω—ã–µ –¢–í-—ç–∫—Ä–∞–Ω—ã ({{ available_tvs|length }})</h3>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
        {% for tv in available_tvs %}
        <div class="tv-select-card" onclick="selectTV({{ tv.id }})">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div style="font-weight: 600;">{{ tv.name }}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">üìç {{ tv.venue_name or '‚Äî' }}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">
                        {% if tv.city %}{{ tv.city }}, {% endif %}{{ tv.address or '' }}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 700; color: var(--accent);">7000 ‚ÇΩ</div>
                    <div style="font-size: 0.7rem; color: var(--text-muted);">/ –º–µ—Å—è—Ü</div>
                </div>
            </div>
            <div style="margin-top: 0.5rem;">
                <span class="badge badge-info">{{ categories.get(tv.category, tv.category or '–î—Ä—É–≥–æ–µ') }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
const PRICE_PER_MONTH = 7000;
const BALANCE = {{ balance|replace(',', '')|replace(' ', '')|default(0) }};

function calculatePrice() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        
        if (days > 0) {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤ (–æ–∫—Ä—É–≥–ª—è–µ–º –≤–≤–µ—Ä—Ö)
            const months = Math.ceil(days / 30);
            const price = months * PRICE_PER_MONTH;
            document.getElementById('price_display').textContent = price.toLocaleString('ru-RU') + ' ‚ÇΩ';
            document.getElementById('price_input').value = price;
            document.getElementById('months_count').textContent = months;
            
            if (price > BALANCE) {
                document.getElementById('balance_warning').style.display = 'block';
                document.getElementById('submit_btn').disabled = true;
                document.getElementById('submit_btn').style.opacity = '0.5';
            } else {
                document.getElementById('balance_warning').style.display = 'none';
                document.getElementById('submit_btn').disabled = false;
                document.getElementById('submit_btn').style.opacity = '1';
            }
        }
    }
}

function selectTV(tvId) {
    document.getElementById('tv_select').value = tvId;
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
{% endblock %}
